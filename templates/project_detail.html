{% extends 'base.html' %}
{% block title %}{{ project.title }} — BaluxStal{% endblock %}

{% block content %}
<section class="detail-section">
    <div class="detail-inner">
        <div class="breadcrumb">
            <a href="{{ url_for('index') }}">← Realizacje</a>
            <span>/ {{ project.category }}</span>
        </div>

        <div class="detail-header">
            <div class="detail-meta-top">
                <span class="detail-category">{{ project.category }}</span>
                {% if project.year %}<span class="detail-year">{{ project.year }}</span>{% endif %}
            </div>
            <h1 class="detail-title">{{ project.title }}</h1>
        </div>

        <!-- Gallery -->
        {% if project.images %}
        <div class="gallery">
            <div class="gallery-main" id="galleryMain">
                <img src="{{ image_url(project.images[0]) }}" 
                     id="mainImg" alt="{{ project.title }}"
                     onclick="openLightbox(current)"
                     style="cursor:zoom-in">
                {% if project.images|length > 1 %}
                <button class="gallery-arrow gallery-prev" onclick="prevImg()">&#8249;</button>
                <button class="gallery-arrow gallery-next" onclick="nextImg()">&#8250;</button>
                <div class="gallery-counter">
                    <span id="currentIdx">1</span> / {{ project.images|length }}
                </div>
                {% endif %}
            </div>
            {% if project.images|length > 1 %}
            <div class="gallery-thumbs">
                {% for img in project.images %}
                <div class="thumb {% if loop.first %}active{% endif %}" 
                     onclick="goToImg({{ loop.index0 }})"
                     data-src="{{ image_url(img) }}">
                    <img src="{{ image_url(img) }}" alt="">
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Lightbox -->
        <div class="lightbox" id="lightbox" onclick="closeLightbox()">
            <button class="lightbox-close" onclick="closeLightbox()">✕</button>
            <button class="lightbox-arrow lightbox-prev" onclick="event.stopPropagation(); lbPrev()">&#8249;</button>
            <button class="lightbox-arrow lightbox-next" onclick="event.stopPropagation(); lbNext()">&#8250;</button>
            <div class="lightbox-img-wrap" onclick="event.stopPropagation()">
                <img id="lightboxImg" src="" alt="">
            </div>
            <div class="lightbox-counter">
                <span id="lbIdx">1</span> / {{ project.images|length }}
            </div>
        </div>
        {% endif %}

        <div class="detail-content">
            <div class="detail-desc">
                <h3>O projekcie</h3>
                <p>{{ project.description }}</p>
            </div>
            <div class="detail-info">
                <h3>Szczegóły</h3>
                <div class="info-list">
                    <div class="info-row">
                        <span class="info-label">Kategoria</span>
                        <span class="info-val">{{ project.category }}</span>
                    </div>
                    {% if project.location %}
                    <div class="info-row">
                        <span class="info-label">Lokalizacja</span>
                        <span class="info-val">{{ project.location }}</span>
                    </div>
                    {% endif %}
                    {% if project.year %}
                    <div class="info-row">
                        <span class="info-label">Rok realizacji</span>
                        <span class="info-val">{{ project.year }}</span>
                    </div>
                    {% endif %}
                    <div class="info-row">
                        <span class="info-label">Zdjęcia</span>
                        <span class="info-val">{{ project.images|length }}</span>
                    </div>
                </div>
                <a href="#kontakt" class="btn-primary" style="margin-top:2rem;display:inline-block">
                    Zamów podobny projekt
                </a>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    const thumbs = document.querySelectorAll('.thumb');
    const images = thumbs.length ? Array.from(thumbs).map(t => t.dataset.src) : ['{{ image_url(project.images[0]) }}'];
    let current = 0;

    function goToImg(idx) {
        current = idx;
        document.getElementById('mainImg').src = images[current];
        const ci = document.getElementById('currentIdx');
        if (ci) ci.textContent = current + 1;
        thumbs.forEach((t, i) => t.classList.toggle('active', i === current));
        if (thumbs[current]) thumbs[current].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
    function nextImg() { goToImg((current + 1) % images.length); }
    function prevImg() { goToImg((current - 1 + images.length) % images.length); }

    // Swipe na głównym zdjęciu
    const mainEl = document.getElementById('galleryMain');
    if (mainEl) {
        let sx = 0, sy = 0;
        mainEl.addEventListener('touchstart', e => { sx = e.touches[0].clientX; sy = e.touches[0].clientY; }, { passive: true });
        mainEl.addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - sx;
            const dy = e.changedTouches[0].clientY - sy;
            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 40) dx < 0 ? nextImg() : prevImg();
        }, { passive: true });
    }

    // ─── LIGHTBOX ───────────────────────────────
    let lbCurrent = 0;

    function openLightbox(idx) {
        lbCurrent = idx;
        document.getElementById('lightboxImg').src = images[lbCurrent];
        document.getElementById('lbIdx').textContent = lbCurrent + 1;
        document.getElementById('lightbox').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        document.getElementById('lightbox').classList.remove('active');
        document.body.style.overflow = '';
    }

    function lbNext() {
        lbCurrent = (lbCurrent + 1) % images.length;
        document.getElementById('lightboxImg').src = images[lbCurrent];
        document.getElementById('lbIdx').textContent = lbCurrent + 1;
    }

    function lbPrev() {
        lbCurrent = (lbCurrent - 1 + images.length) % images.length;
        document.getElementById('lightboxImg').src = images[lbCurrent];
        document.getElementById('lbIdx').textContent = lbCurrent + 1;
    }

    // Swipe w lightboxie
    const lb = document.getElementById('lightbox');
    if (lb) {
        let lbsx = 0, lbsy = 0;
        lb.addEventListener('touchstart', e => { lbsx = e.touches[0].clientX; lbsy = e.touches[0].clientY; }, { passive: true });
        lb.addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - lbsx;
            const dy = e.changedTouches[0].clientY - lbsy;
            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 40) dx < 0 ? lbNext() : lbPrev();
        }, { passive: true });
    }

    // Klawiatura
    document.addEventListener('keydown', e => {
        const lbActive = document.getElementById('lightbox').classList.contains('active');
        if (lbActive) {
            if (e.key === 'ArrowRight') lbNext();
            if (e.key === 'ArrowLeft') lbPrev();
            if (e.key === 'Escape') closeLightbox();
        } else {
            if (e.key === 'ArrowRight') nextImg();
            if (e.key === 'ArrowLeft') prevImg();
        }
    });
</script>
{% endblock %}
